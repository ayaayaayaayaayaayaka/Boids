# 群れ行動における Confusion Effect の検証実験

## 1. 緒言

### 1.1 背景

自然界において、魚類や鳥類などの群れ行動は捕食者からの防御機構として機能することが知られている。特に「Confusion Effect」と呼ばれる現象は、群れの中に多数の個体が存在することで捕食者の標的選択が困難になり、捕食成功率が低下するというものである。

Ioannou et al. (2008) は、捕食者が群れの中から単一の標的を選択・追跡する際、視野内の個体数が増加するほど追跡精度が低下することを実験的に示した。本研究では、Boid アルゴリズムを用いた群れシミュレーションにおいて、この Confusion Effect を再現し、群れのパラメータが捕食成功率に与える影響を定量的に評価する。

### 1.2 目的

本実験の目的は以下の通りである。

1. Confusion Effect を組み込んだ捕食者モデルを実装し、論文の知見を再現する
2. 群れの個体数および密度が捕食成功率に与える影響を定量化する
3. 群れパラメータ（結合力、整列力、分離力）の変化が防御効果に与える影響を検証する

---

## 2. 実験手法

### 2.1 シミュレーション環境

本実験では Unity エンジン上で Boid アルゴリズムに基づく群れシミュレーションを構築した。空間は原点を中心とした半径 50 の球状領域とし、被捕食者（小魚）および捕食者（大魚）はこの領域内でのみ行動する。

### 2.2 被捕食者モデル（Boid）

被捕食者の行動は Reynolds (1987) の Boid モデルに基づき、以下の3つの力の重ね合わせで決定される。

| 力の種類 | 説明 | パラメータ |
|----------|------|------------|
| Alignment（整列） | 近傍個体と同じ方向に向かう | `alignWeight` |
| Cohesion（結合） | 近傍個体の重心に向かう | `cohesionWeight` |
| Separation（分離） | 近傍個体から離れる | `seperateWeight` |

加えて、捕食者を検知した場合は逃避行動を取る。捕食者との距離が一定以下になると、捕食者から離れる方向に強い力が加わる。

#### 被捕食者パラメータ

| パラメータ | 記号 | 標準値 | 単位 |
|------------|------|--------|------|
| 最小速度 | $v_{min}$ | 2 | m/s |
| 最大速度 | $v_{max}$ | 5 | m/s |
| 知覚半径 | $r_p$ | 2.5 | m |
| 回避半径 | $r_a$ | 1 | m |
| 整列重み | $w_{align}$ | 1 | - |
| 結合重み | $w_{cohesion}$ | 5 | - |
| 分離重み | $w_{separate}$ | 1 | - |

### 2.3 捕食者モデル（Confusion Predator）

捕食者の行動は Ioannou et al. (2008) の知見に基づき、以下の特性を持つ。

#### 視覚システム

- **視野半径**: 捕食者を中心とした球状の知覚範囲
- **視野角**: 前方を中心とした扇形の視野
- **死角（Blind Spot）**: 後方には視野が存在しない

#### ターゲット選択（論文 Fig.2 準拠）

捕食者は「最後に視野内に入った個体」を追跡対象とする。これにより、群れが捕食者の前を横切ると、次々と新しい個体に注意が移る「目移り」が発生する。ただし、ターゲット切り替え後一定時間（クールダウン）は切り替えを行わない。

#### Confusion Effect の実装

視野内の個体数 $n$ に応じて「混乱度」$C$ を計算する。

$$C = \min\left(1, \frac{n}{n_{max}}\right) \times s$$

ここで $n_{max}$ は最大混乱個体数、$s$ は混乱強度パラメータである。

混乱度に応じて以下の効果が発生する。

1. **追跡角度のずれ**: 混乱度に比例した角度誤差が追跡方向に加わる
2. **旋回速度の低下**: 混乱度に応じて方向転換が鈍くなる
3. **移動速度の低下**: 混乱度に応じて移動速度が若干低下する

#### 捕食者パラメータ

| パラメータ | 記号 | 標準値 | 単位 |
|------------|------|--------|------|
| 移動速度 | $v_p$ | 10 | m/s |
| 視野半径 | $r_v$ | 20 | m |
| 視野角 | $\theta_v$ | 120 | 度 |
| 死角 | $\theta_b$ | 40 | 度 |
| 捕食判定距離 | $r_c$ | 1.2 | m |
| 混乱強度 | $s$ | 0.5 | - |
| 最大混乱個体数 | $n_{max}$ | 10 | 個体 |
| 最大角度ずれ | $\delta_{max}$ | 30 | 度 |
| ターゲット切替クールダウン | $t_{cd}$ | 1.5 | 秒 |

### 2.4 評価指標

捕食の成功度合いを以下の指標で評価する。

| 指標 | 定義 | 意味 |
|------|------|------|
| 最初の捕食までの時間 | 実験開始から1匹目を捕食するまでの時間 | 群れへの侵入困難度 |
| 時間当たり捕食数 | 総捕食数 ÷ 実験時間 × 60 | 捕食効率（kills/min） |
| ターゲット切替回数 | 追跡対象を変更した回数 | 混乱の程度 |

### 2.5 実験手順

1. シーンに ExperimentLogger を配置し、BoidSettings を設定する
2. **Experiment Condition** に条件名（A1, A2, A3, B1, B2, B3, C1, C2, C3）を入力する
3. 条件に応じて Spawner（個体数）、BoidSettings（cohesionWeight）、ConfusionPredator（confusionStrength）を設定する
4. 実験を開始（再生ボタン）し、一定数の捕食または一定時間経過まで観察する
5. 実験を終了（停止ボタン）すると、summary と CSV が自動保存される
6. 条件を変えて 2〜3 を繰り返し、結果を比較する

---

## 3. 仮説

本実験では以下の仮説を検証する。

### 仮説 1: 群れの個体数と捕食成功率

群れの個体数が増加すると、捕食者の視野内に入る個体数が増加し、Confusion Effect により捕食成功率が低下する。具体的には以下を予測する。

- **最初の捕食までの時間**: 個体数に比例して増加
- **時間当たり捕食数**: 個体数に反比例して減少

### 仮説 2: 群れの密度と捕食成功率

群れの密度（結合力 `cohesionWeight`）が高いほど、個体が密集するため捕食者の視野内に同時に多数の個体が入り、Confusion Effect が強まる。

- **結合力が高い群れ**: 密集により混乱度上昇 → 捕食困難
- **結合力が低い群れ**: 分散により個体が孤立 → 捕食容易

### 仮説 3: 整列力と群れの形状

整列力 `alignWeight` が高いと群れ全体が同方向に移動するため、捕食者の視野内で個体の入れ替わりが少なくなる。これにより目移りが抑制され、捕食成功率が上昇すると予測する。

---

## 4. 実験条件

### 4.1 条件設定例

ExperimentLogger の **Experiment Condition** に以下を入力し、対応するパラメータを設定してから再生する。

#### 実験 A: 個体数の影響

| 条件 | Experiment Condition | Spawner: Spawn Count | その他 |
|------|----------------------|----------------------|--------|
| A1 | A1 | 20 | 標準値 |
| A2 | A2 | 50 | 標準値 |
| A3 | A3 | 100 | 標準値 |

#### 実験 B: 結合力の影響

| 条件 | Experiment Condition | BoidSettings: Cohesion Weight | その他 |
|------|----------------------|-------------------------------|--------|
| B1 | B1 | 1（疎な群れ） | 標準値 |
| B2 | B2 | 5（標準） | 標準値 |
| B3 | B3 | 15（密な群れ） | 標準値 |

#### 実験 C: 混乱強度の影響

| 条件 | Experiment Condition | ConfusionPredator: Confusion Strength | その他 |
|------|----------------------|----------------------------------------|--------|
| C1 | C1 | 0（混乱なし） | 標準値 |
| C2 | C2 | 0.5（標準） | 標準値 |
| C3 | C3 | 1.0（最大混乱） | 標準値 |

### 4.2 実験終了の基準

各条件につき以下のいずれかで実験を終了する。

- 5匹以上捕食した時点
- 3分経過した時点
- 全個体が捕食された時点

同一条件で3回以上実験を行い、平均値を用いて比較する。

---

## 5. 出力ファイル

実験終了時に `Assets/ExperimentData/` に以下のみ生成される（グラフ化に必要なデータのみ）。

| ファイル | 内容 |
|----------|------|
| `*_summary.txt` | 条件名、初期個体数、結合力・混乱強度、総捕食数、最初の捕食までの時間、捕食率 |
| `*_captures.csv` | 各捕食イベント（condition, time_sec, kill_number, capture_rate_per_min, boids_in_view, remaining_boids） |
| `*_snapshots.csv` | 5秒ごとの群れ状態（condition, time_sec, total_boids, total_kills, capture_rate_per_min, avg_neighbor_dist, polarization） |

複数条件の CSV を結合し、`condition` 列でフィルタしてグラフ化する。

---

## 6. 考察の観点

実験結果を分析する際、以下の観点から考察を行う。

### 6.1 Confusion Effect の検証

- 視野内個体数と捕食成功率の関係をグラフ化し、負の相関が見られるか確認する
- ターゲット切替回数と捕食成功率の関係を分析する

### 6.2 群れパラメータの影響

- 結合力・整列力・分離力の各パラメータが、群れの形状（密度、極性）にどう影響するか
- 群れの形状が捕食成功率にどう影響するか

### 6.3 生態学的意義

- シミュレーション結果が自然界の観察と一致するか
- 群れ行動が個体の生存率向上にどの程度寄与するか

---

## 7. 参考文献

1. Reynolds, C. W. (1987). Flocks, herds and schools: A distributed behavioral model. *ACM SIGGRAPH Computer Graphics*, 21(4), 25-34.

2. Ioannou, C. C., Tosh, C. R., Neville, L., & Krause, J. (2008). The confusion effect—from neural networks to reduced predation risk. *Behavioral Ecology*, 19(1), 126-130.

3. Couzin, I. D., Krause, J., James, R., Ruxton, G. D., & Franks, N. R. (2002). Collective memory and spatial sorting in animal groups. *Journal of Theoretical Biology*, 218(1), 1-11.

4. Hamilton, W. D. (1971). Geometry for the selfish herd. *Journal of Theoretical Biology*, 31(2), 295-311.

---

## 8. 付録：データ分析手順

### 8.1 複数条件の CSV を結合して読み込む

各実験で `*_captures.csv` と `*_snapshots.csv` を出力する。複数回実験したら、それらを 1 つの CSV に結合し、`condition` 列で条件ごとに比較する。

```python
import pandas as pd
import matplotlib.pyplot as plt
import glob

# 全 captures を結合（condition 列で A1, A2, ... が入っている）
files = glob.glob('Assets/ExperimentData/*_captures.csv')
captures_list = [pd.read_csv(f) for f in files]
captures_all = pd.concat(captures_list, ignore_index=True)

# 条件ごとの要約（最後の捕食イベントの capture_rate_per_min など）
summary = captures_all.groupby('condition').agg({
    'kill_number': 'max',
    'time_sec': 'max',
    'capture_rate_per_min': 'last'
}).reset_index()
print(summary)
```

### 8.2 捕食の時系列グラフ（条件別）

```python
for cond in captures_all['condition'].unique():
    df = captures_all[captures_all['condition'] == cond]
    plt.plot(df['time_sec'], df['kill_number'], marker='o', label=cond)
plt.xlabel('Time (sec)')
plt.ylabel('Cumulative Kills')
plt.legend()
plt.title('Predation Progress by Condition')
plt.grid(True)
plt.savefig('predation_timeline.png')
```

### 8.3 条件間の比較（A1, A2, A3 など）

summary.txt から First Kill Time と Capture Rate を手でまとめるか、captures の最初の行から first kill time を計算する。

```python
# 条件ごとに最初の捕食時間を取得
first_kill = captures_all[captures_all['kill_number'] == 1].groupby('condition')['time_sec'].first()
# 条件ごとの最終捕食率（最後のイベントの capture_rate_per_min）
rate = captures_all.groupby('condition').apply(lambda g: g.iloc[-1]['capture_rate_per_min'])

fig, axes = plt.subplots(1, 2, figsize=(12, 5))
axes[0].bar(first_kill.index, first_kill.values)
axes[0].set_ylabel('First Kill Time (sec)')
axes[0].set_title('Effect of Condition on First Kill Time')
axes[1].bar(rate.index, rate.values)
axes[1].set_ylabel('Capture Rate (kills/min)')
axes[1].set_title('Effect of Condition on Capture Rate')
plt.tight_layout()
plt.savefig('comparison.png')
```
