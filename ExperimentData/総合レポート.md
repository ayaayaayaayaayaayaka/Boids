# 群れ行動シミュレーションにおける Confusion Effect の検証

## 1. はじめに

### 1.1 研究背景

自然界において、魚類や鳥類などの多くの動物は群れを形成して行動する。この群れ行動には、捕食者からの防御という適応的意義があると考えられている。特に「Confusion Effect（混乱効果）」は、群れ内の多数の個体が捕食者の標的選択を困難にし、捕食成功率を低下させる現象として知られている。

Ioannou et al. (2008) は、人工ニューラルネットワークを用いた実験により、視野内の標的数が増加すると捕食者の追跡精度が低下することを示した。本研究では、この知見をコンピュータシミュレーションにより再現し、群れパラメータが捕食成功率に与える影響を定量的に検証した。

### 1.2 研究目的

本研究の目的は以下の通りである。

1. Boid アルゴリズムに基づく群れシミュレーションを構築し、Confusion Effect を実装する
2. 群れの個体数、密度、混乱強度が捕食効率に与える影響を定量的に評価する
3. Ioannou et al. (2008) の論文で示された知見をシミュレーションにより検証する

---

## 2. 実現したシステム

### 2.1 システム概要

本システムは Unity エンジン上で動作する群れ行動シミュレーションである。被捕食者（小魚）の群れと捕食者（大魚）を3次元空間内に配置し、その相互作用をリアルタイムで観察・計測できる。

**開発環境**
- Unity 2022.3 LTS
- C# スクリプト
- 半径50mの球形空間

### 2.2 創意工夫した点

#### 2.2.1 Confusion Effect の実装（論文 Fig.2 準拠）

本研究の最大の工夫は、Ioannou et al. (2008) の論文 Fig.2 で示された捕食者の行動パターンを忠実に再現したことである。

**論文の知見**:
- 捕食者は「最後に視野に入った個体」に注意が移る（目移り）
- 視野内の個体数が増加すると追跡精度が低下する

**実装した機能**:

```csharp
// 混乱度の計算
float rawConfusion = Mathf.Clamp01((float)currentBoidsInView / maxConfusionCount);
currentConfusion = rawConfusion * confusionStrength;

// クールダウンが終了し、新しく視界に入った魚がいる場合
if (cooldownOver && newlyEnteredBoids.Count > 0) {
    // 最後に視界に入った魚をターゲットに（論文 Fig.2）
    SwitchTarget(newlyEnteredBoids[newlyEnteredBoids.Count - 1]);
}
```

#### 2.2.2 クールダウン機構の導入

論文の行動を完全に再現すると、捕食者は頻繁にターゲットを切り替えて一匹も捕食できなくなる問題が発生した。そこで、ターゲット切り替え後に1.5秒のクールダウンを設け、論文の行動を再現しつつ実験として成立する程度の捕食を可能にした。

```csharp
float timeSinceSwitch = Time.time - lastSwitchTime;
bool cooldownOver = timeSinceSwitch > targetSwitchCooldown;
```

#### 2.2.3 追跡精度の低下（Perlin Noise による自然な「迷い」）

混乱時の追跡精度低下を、単純なランダムノイズではなく Perlin Noise で実装した。これにより、時間的に滑らかに変化する自然な「迷い」を表現できた。

```csharp
float noiseX = Mathf.PerlinNoise(Time.time * 1.5f, 0f) - 0.5f;
float noiseY = Mathf.PerlinNoise(0f, Time.time * 1.5f) - 0.5f;
float deviationH = maxAngleDeviation * currentConfusion * noiseX * 2f;
Quaternion deviation = Quaternion.Euler(deviationV, deviationH, 0f);
targetDir = deviation * targetDir;
```

#### 2.2.4 球形空間による自然な回遊行動

壁との衝突による不自然な群れの崩壊を避けるため、半径50mの球形空間を採用した。境界に近づくと中心方向への力が働き、境界外に出ると強制的に押し戻される3段階の境界制御を実装した。

#### 2.2.5 自動実験終了と CSV 出力

10匹捕食時に自動的に実験が終了し、データがCSV形式で保存される機能を実装した。これにより、複数条件での比較実験を効率的に行える。

---

## 3. アルゴリズムの説明

### 3.1 被捕食者（Boid）のアルゴリズム

Reynolds (1987) の Boid アルゴリズムに基づき、以下の3つの力の合成により移動を決定する。

| 力 | 説明 | 数式 |
|---|---|---|
| Alignment | 近傍個体と同じ方向に向かう | $\vec{a}_{align} = w_{align} \cdot \text{SteerTowards}(\vec{v}_{avg})$ |
| Cohesion | 近傍個体の重心に向かう | $\vec{a}_{cohesion} = w_{cohesion} \cdot \text{SteerTowards}(\vec{c} - \vec{p})$ |
| Separation | 近傍個体から離れる | $\vec{a}_{separate} = w_{separate} \cdot \text{SteerTowards}(\vec{d}_{avoid})$ |

**捕食者回避**:
捕食者との距離が15m以内の場合、捕食者から離れる方向に強い力（重み15.0）を加える。

### 3.2 捕食者（ConfusionPredator）のアルゴリズム

#### 3.2.1 視野判定

```
各個体について:
    距離 < viewRadius AND
    角度 < viewAngle/2 AND
    角度 < (180 - blindAngle/2)
    → 視野内と判定
```

#### 3.2.2 ターゲット選択

```
1. 現在のターゲットが視界外 → 新ターゲット選択
2. 現在のターゲットが遠すぎる（>15m）→ 新ターゲット選択
3. クールダウン終了 AND 新規個体あり → 最後に入った個体に切り替え
4. それ以外 → 現在のターゲット維持
```

#### 3.2.3 Confusion Effect

混乱度 $C$ は以下の式で計算される。

$$C = \min\left(1, \frac{n}{n_{max}}\right) \times s$$

ここで $n$ は視野内個体数、$n_{max}$ は最大混乱個体数（10）、$s$ は混乱強度パラメータである。

混乱度に応じて以下の効果が適用される。

| 効果 | 数式 |
|---|---|
| 追跡角度のずれ | $\delta = \delta_{max} \times C \times \text{PerlinNoise}$ |
| 旋回速度の低下 | $\omega_{eff} = \omega_{base} \times (1 - C \times 0.5)$ |
| 移動速度の低下 | $v_{eff} = v_{base} \times (1 - C \times 0.15)$ |

---

## 4. ソースコードの説明

### 4.1 主要クラス構成

| クラス | 役割 | ファイル |
|---|---|---|
| Boid | 被捕食者の行動制御 | Boid.cs |
| BoidSettings | 群れパラメータの管理 | BoidSettings.cs |
| ConfusionPredator | 捕食者の行動制御 | ConfusionPredator.cs |
| ExperimentLogger | 実験データの記録・保存 | ExperimentLogger.cs |
| Spawner | 初期個体の生成 | Spawner.cs |

### 4.2 ConfusionPredator.cs の主要メソッド

#### UpdateTarget()
毎フレーム呼び出され、視野内の個体を検出し、ターゲットを選択する。

```csharp
void UpdateTarget() {
    // 1. 全個体をスキャンし、視野内の個体を検出
    foreach (Boid b in allBoids) {
        Vector3 toBoid = b.transform.position - transform.position;
        float dist = toBoid.magnitude;
        float angle = Vector3.Angle(transform.forward, toBoid);
        
        if (dist < viewRadius && angle < viewAngle / 2f) {
            currentInView.Add(b);
            if (!boidsInViewLastFrame.Contains(b)) {
                newlyEnteredBoids.Add(b);  // 新規検出
            }
        }
    }
    
    // 2. 混乱度を計算
    currentConfusion = Mathf.Clamp01(currentBoidsInView / maxConfusionCount) 
                       * confusionStrength;
    
    // 3. ターゲット選択ロジック（論文 Fig.2 準拠）
    // ...
}
```

#### Move()
ターゲットに向かって移動し、混乱度に応じて追跡精度を低下させる。

```csharp
void Move() {
    if (currentTarget != null) {
        Vector3 targetDir = (currentTarget.transform.position - transform.position).normalized;
        
        // 混乱度に応じた角度ずれを適用
        if (currentConfusion > 0.05f) {
            Quaternion deviation = CalculateDeviation();
            targetDir = deviation * targetDir;
        }
        
        // 旋回と移動
        float effectiveTurnSpeed = baseTurnSpeed * (1f - currentConfusion * 0.5f);
        transform.forward = Vector3.Slerp(transform.forward, targetDir, 
                                          Time.deltaTime * effectiveTurnSpeed);
        
        // 捕食判定
        if (Vector3.Distance(transform.position, currentTarget.transform.position) 
            < captureRadius) {
            CapturePrey(currentTarget);
        }
    }
}
```

### 4.3 ExperimentLogger.cs の主要機能

- 実験開始時の初期個体数とパラメータを記録
- 各捕食イベントの詳細（時刻、視野内個体数）をCSV形式で保存
- 5秒ごとの群れ状態スナップショットを記録
- 10匹捕食時に自動的に実験を終了

---

## 5. 実験結果

### 5.1 実験条件

全9条件で実験を実施した。

| グループ | 操作変数 | 条件 |
|---|---|---|
| A | 初期個体数 | A1: 20匹, A2: 50匹, A3: 100匹 |
| B | 結合力（Cohesion） | B1: 1, B2: 5, B3: 15 |
| C | 混乱強度（Confusion） | C1: 0, C2: 0.5, C3: 1.0 |

### 5.2 実験結果一覧

| 条件 | 初期個体数 | Cohesion | Confusion | 最初の捕食(秒) | 捕食率(/分) |
|------|------------|----------|-----------|----------------|-------------|
| A1 | 20 | 1 | 0.5 | 13.37 | 8.33 |
| A2 | 50 | 1 | 0.5 | 12.49 | 11.50 |
| A3 | 100 | 1 | 0.5 | 9.81 | 12.40 |
| B1 | 100 | 1 | 0.5 | 12.24 | 20.61 |
| B2 | 100 | 5 | 0.5 | 12.96 | 45.86 |
| B3 | 100 | 15 | 0.5 | 15.86 | 37.52 |
| C1 | 100 | 5 | 0 | 11.53 | **51.41** |
| C2 | 100 | 5 | 0.5 | 13.76 | 43.37 |
| C3 | 100 | 5 | 1.0 | 10.23 | **23.24** |

### 5.3 グラフによる結果表示

#### 図1: 条件間の比較
（comparison_conditions.png を参照）

左から順に「最初の捕食までの時間」「時間当たり捕食数」「10匹捕食までの時間」を示す。赤色が実験A（個体数）、青色が実験B（結合力）、緑色が実験C（混乱強度）である。

#### 図2: 実験グループ別の傾向
（experiment_groups.png を参照）

各実験グループ（A, B, C）について、条件による変化を示す。青色のバーが「最初の捕食時間」、赤色のバーが「捕食率」である。

#### 図3: 捕食の時系列比較
（predation_timeline.png を参照）

横軸が経過時間（秒）、縦軸が累積捕食数を示す。C1（混乱なし）が最も速く10匹に到達し、A1（少数群れ）が最も遅いことがわかる。

#### 図4: Confusion Effect の検証
（confusion_effect.png を参照）

左図は捕食時の視野内個体数の分布を示す。中央値は23匹であった。右図は視野内個体数と次の捕食までの時間の関係を示す。傾きは-0.076であり、視野内個体数が多いほど捕食間隔が短くなる傾向が見られた。

---

## 6. 考察と評価

### 6.1 仮説の検証結果

| 仮説 | 結果 | 判定 |
|------|------|------|
| 個体数が多いほど捕食されにくい | 逆の結果（個体数↑で捕食率↑） | **棄却** |
| 群れが密集するほど捕食されにくい | 部分的に支持（高密度で捕食率↓） | **部分的支持** |
| Confusion Effect により捕食成功率が低下 | 強く支持（Confusion↑で捕食率55%↓） | **支持** |

### 6.2 Confusion Effect の有効性

実験Cの結果から、Confusion Effect の有効性が明確に確認された。

- **Confusion = 0（混乱なし）**: 捕食率 51.41/分
- **Confusion = 0.5（中程度）**: 捕食率 43.37/分（-16%）
- **Confusion = 1.0（最大）**: 捕食率 23.24/分（**-55%**）

Confusion Strength を最大にすると、捕食率は約55%低下した。これは Ioannou et al. (2008) の知見と一致し、視野内の個体数増加により捕食者のターゲット選択が混乱するという仮説を強く支持する結果である。

### 6.3 群れ密度の非線形効果

実験Bでは、群れの密度と捕食率の関係が非単調であることが示された。

- **B1（Cohesion=1, 疎な群れ）**: 捕食率 20.61/分
- **B2（Cohesion=5, 標準）**: 捕食率 45.86/分（**最大**）
- **B3（Cohesion=15, 密な群れ）**: 捕食率 37.52/分

中程度の密度（Cohesion=5）で捕食率が最大となり、高密度（Cohesion=15）では Confusion Effect により捕食率が低下した。これは、群れの密度が高すぎると捕食者の視野内に多数の個体が入り、混乱が生じることを示唆している。

### 6.4 個体数増加のトレードオフ

実験Aでは、個体数が増加すると捕食率が向上するという、仮説に反する結果が得られた。

- **A1（20匹）**: 捕食率 8.33/分
- **A2（50匹）**: 捕食率 11.50/分
- **A3（100匹）**: 捕食率 12.40/分

この結果は、疎な群れ（Cohesion=1）では個体数増加による「発見確率の増加」が Confusion Effect を上回ることを示している。群れの防御効果を発揮するには、十分な密度で群れを形成する必要がある。

### 6.5 実験の限界と今後の課題

1. **試行回数の不足**: 各条件で1回のみの実験であり、統計的有意性の検証には複数回の試行が必要である。

2. **パラメータの交絡**: 実験A, B, Cで基準パラメータが異なるため、完全な比較は困難である。

3. **長期的効果の未検証**: 10匹捕食で実験を終了しているため、群れサイズが減少した場合の効果は観察できていない。

---

## 7. 結論

本研究では、Boid アルゴリズムに基づく群れシミュレーションを構築し、Ioannou et al. (2008) の論文で示された Confusion Effect を実装・検証した。主な知見は以下の通りである。

1. **Confusion Effect は有効である**: 混乱強度を最大にすると、捕食率は約55%低下した。

2. **群れの密度には最適値がある**: 中程度の密度では連続捕食のリスクが高まるが、高密度では Confusion Effect により捕食リスクが低下する。

3. **個体数増加は必ずしも防御的ではない**: 疎な群れでは、発見確率の増加が混乱効果を上回り、捕食率が向上する。

4. **群れ行動の適応的意義**: 本結果は、密集した群れ形成が捕食者からの防御に有効であることを示唆している。

---

## 参考文献

1. Ioannou, C. C., Tosh, C. R., Neville, L., & Krause, J. (2008). The confusion effect—from neural networks to reduced predation risk. *Behavioral Ecology*, 19(1), 126-130.

2. Reynolds, C. W. (1987). Flocks, herds and schools: A distributed behavioral model. *ACM SIGGRAPH Computer Graphics*, 21(4), 25-34.

3. Couzin, I. D., Krause, J., James, R., Ruxton, G. D., & Franks, N. R. (2002). Collective memory and spatial sorting in animal groups. *Journal of Theoretical Biology*, 218(1), 1-11.

---

## 付録：生成されたグラフ一覧

1. **comparison_conditions.png** - 条件間の比較（最初の捕食時間、捕食率、10匹捕食時間）
2. **experiment_groups.png** - 実験グループ別の傾向（A, B, C）
3. **predation_timeline.png** - 捕食の時系列比較
4. **confusion_effect.png** - Confusion Effect の検証（視野内個体数と捕食効率の関係）
